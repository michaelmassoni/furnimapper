<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Plan Furnitures Tool</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Include Konva.js library -->
    <script src="https://unpkg.com/konva@8.4.3/konva.min.js"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

</head>

<body>
    <div class="theme-toggle-container">
        <button id="theme-toggle-btn" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-moon-stars-fill"></i>
        </button>
    </div>

    <div class="container">
        <h1 class="mb-4">FurniMapper</h1>

        <div class="row align-items-center mb-3">
            <div class="col-md-6">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">Upload Floor Plan Image:</span>
                    <input type="file" id="image-upload" class="form-control" accept="image/*">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group input-group-sm">
                    <button id="import-btn" class="btn btn-primary">Import Grid</button>
                    <input type="file" id="json-upload" accept=".json" style="display: none;">
                    <span id="import-file-name"
                        class="form-control bg-light text-muted fst-italic text-truncate">Furniture not loaded</span>
                </div>
            </div>
        </div>
        <!-- Hidden toggle for dimensions -->
        <input type="checkbox" id="show-dimensions-toggle" style="display: none;">
        <div class="controls">
            <!-- Step 1: Scale -->
            <button id="define-scale-btn" class="btn btn-purple btn-sm scale-btn">Define Scale</button>
            <button id="auto-detect-btn" class="btn btn-outline-purple btn-sm"
                title="Experimental: Auto-detect scale from room labels">Auto Scale</button>
            <div class="vr mx-2"></div>

            <!-- Step 2: Add Content -->
            <button id="add-rectangle-btn" class="btn btn-primary btn-sm rectangle-btn">Add Item</button>
            <button id="paste-furniture-btn" class="btn btn-success btn-sm">Import List</button>
            <div class="vr mx-2"></div>

            <!-- Step 3: Edit Actions -->
            <button id="undo-btn" class="btn btn-secondary btn-sm" title="Undo (Ctrl+Z)" disabled><i
                    class="bi bi-arrow-counterclockwise"></i></button>
            <button id="redo-btn" class="btn btn-secondary btn-sm" title="Redo (Ctrl+Y)" disabled><i
                    class="bi bi-arrow-clockwise"></i></button>
            <button id="duplicate-object-btn" class="btn btn-info btn-sm" title="Duplicate Selected" disabled><i
                    class="bi bi-files"></i></button>
            <button id="rotate-left-btn" class="btn btn-warning btn-sm rotate-btn" title="Rotate Left (L)" disabled><i
                    class="bi bi-arrow-counterclockwise"></i></button>
            <button id="rotate-object-btn" class="btn btn-warning btn-sm rotate-btn" title="Rotate Right (R)"
                disabled><i class="bi bi-arrow-clockwise"></i></button>
            <button id="delete-object-btn" class="btn btn-danger btn-sm delete-btn" title="Delete Selected (Del)"
                disabled><i class="bi bi-trash"></i></button>
            <div class="vr mx-2"></div>

            <!-- Step 4: Output -->
            <button id="export-btn" class="btn btn-secondary btn-sm" disabled>Export Grid</button>
        </div>

        <div class="canvas-wrapper">
            <div id="canvas-container"></div>
        </div>


    </div>

    <!-- Rectangle Modal -->
    <div id="rectangle-modal" class="modal">
        <div class="modal-content">
            <h3>Add Furniture</h3>
            <div class="input-group">
                <label for="rectangle-width">Width (cm):</label>
                <input type="number" id="rectangle-width" min="1" step="1" placeholder="Enter width">
            </div>
            <div class="input-group">
                <label for="rectangle-height">Height (cm):</label>
                <input type="number" id="rectangle-height" min="1" step="1" placeholder="Enter height">
            </div>
            <div class="input-group">
                <label for="rectangle-label">Label:</label>
                <input type="text" id="rectangle-label" placeholder="Enter label (e.g., Desk, Sofa)">
            </div>
            <div class="modal-buttons">
                <button id="cancel-rectangle-btn" class="btn btn-secondary btn-sm">Cancel</button>
                <button id="add-rectangle-confirm-btn" class="btn btn-primary btn-sm">Add Furniture</button>
            </div>
        </div>
    </div>

    <!-- Furniture Builder Modal -->
    <div id="paste-furniture-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <h3>Furniture Builder</h3>
            <p class="text-muted small">Build a list of furniture to add to your plan.</p>

            <!-- List View -->
            <div id="furniture-list-container" class="mb-3"
                style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                <table class="table table-sm table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th style="width: 80px;">Width (cm)</th>
                            <th style="width: 80px;">Depth (cm)</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="furniture-list-body">
                        <!-- Items will be added here -->
                    </tbody>
                </table>
                <div id="empty-list-message" class="text-center text-muted mt-3 py-4">
                    List is empty. Add items manually or paste from spreadsheet.
                </div>
            </div>

            <!-- Manual Add Controls -->
            <div class="row g-2 mb-3 align-items-end">
                <div class="col-4">
                    <label class="small text-muted">Label</label>
                    <input type="text" id="builder-label" class="form-control form-control-sm" placeholder="e.g. Chair">
                </div>
                <div class="col-3">
                    <label class="small text-muted">Width</label>
                    <input type="number" id="builder-width" class="form-control form-control-sm" placeholder="cm">
                </div>
                <div class="col-3">
                    <label class="small text-muted">Depth</label>
                    <input type="number" id="builder-depth" class="form-control form-control-sm" placeholder="cm">
                </div>
                <div class="col-2">
                    <button id="builder-add-btn" class="btn btn-primary btn-sm w-100"><i class="bi bi-plus"></i>
                        Add</button>
                </div>
            </div>

            <!-- Bulk Paste Toggle -->
            <div class="mb-3">
                <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button" data-bs-toggle="collapse"
                    data-bs-target="#bulk-paste-section">
                    <i class="bi bi-clipboard-plus"></i> Import from Spreadsheet / CSV
                </button>
                <div class="collapse mt-2" id="bulk-paste-section">
                    <div class="card card-body p-2 bg-light">
                        <textarea id="furniture-data" class="form-control form-control-sm" rows="4"
                            placeholder="Paste data here (Label, Width, Depth)..."></textarea>
                        <button id="process-bulk-paste-btn" class="btn btn-secondary btn-sm mt-2">Process & Add to
                            List</button>
                    </div>
                </div>
            </div>

            <div class="modal-buttons d-flex justify-content-between">
                <button id="cancel-paste-btn" class="btn btn-secondary">Cancel</button>
                <div>
                    <button id="clear-list-btn" class="btn btn-outline-danger me-2">Clear List</button>
                    <button id="commit-furniture-btn" class="btn btn-success">Add All to Plan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text">Analyzing Floor Plan...</div>
    </div>

    <script src="helpers.js"></script>
    <script src="app.js"></script>
</body>

</html>